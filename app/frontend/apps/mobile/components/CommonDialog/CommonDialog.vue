<!-- Copyright (C) 2012-2022 Zammad Foundation, https://zammad-foundation.org/ -->

<script setup lang="ts">
import type { EventHandlers } from '@shared/types/utils'
import { usePointerSwipe } from '@vueuse/core'
import type { Events } from 'vue'
import { ref } from 'vue'
import { useDialogState } from './composable'

const props = defineProps<{
  name: string
  label?: string
  content?: string
  listeners?: {
    done?: EventHandlers<Events>
  }
}>()

defineEmits<{
  (e: 'close'): void
}>()

const PX_SWIPE_CLOSE = -150

const top = ref('0')
const dialogElement = ref<HTMLElement>()

const { close } = useDialogState(props)
const { distanceY, isSwiping } = usePointerSwipe(dialogElement, {
  onSwipe() {
    if (distanceY.value < 0) {
      const distance = Math.abs(distanceY.value)
      top.value = `${distance}px`
    } else {
      top.value = '0'
    }
  },
  onSwipeEnd() {
    if (distanceY.value <= PX_SWIPE_CLOSE) {
      close()
    } else {
      top.value = '0'
    }
  },
  pointerTypes: ['touch', 'pen'],
})
</script>

<script lang="ts">
export default {
  inheritAttrs: false,
}
</script>

<template>
  <div
    class="fixed inset-0 z-10 flex overflow-y-auto"
    :aria-label="$t(label || name)"
    role="dialog"
  >
    <div
      :id="`dialog-${name}`"
      ref="dialogElement"
      class="flex h-full grow flex-col bg-black"
      :class="{ 'transition-all duration-200 ease-linear': !isSwiping }"
      :style="{ transform: `translateY(${top})` }"
    >
      <div class="mx-4 h-2.5 shrink-0 rounded-t-xl bg-gray-150/40" />
      <div
        class="relative flex h-16 shrink-0 select-none items-center justify-center rounded-t-xl bg-gray-600/80"
      >
        <div class="absolute top-0 left-0 bottom-0 flex items-center pl-4">
          <slot name="before-label" />
        </div>
        <div
          class="grow text-center text-base font-semibold leading-[19px] text-white"
        >
          <slot name="label">
            {{ $t(label) }}
          </slot>
        </div>
        <div class="absolute top-0 right-0 bottom-0 flex items-center pr-4">
          <slot name="after-label">
            <button
              class="grow text-blue"
              tabindex="0"
              role="button"
              v-bind="listeners?.done"
              @pointerdown.stop
              @click="close()"
              @keypress.space="close()"
            >
              {{ $t('Done') }}
            </button>
          </slot>
        </div>
      </div>
      <div
        class="flex grow flex-col items-start overflow-y-auto bg-black text-white"
        v-bind="$attrs"
      >
        <slot>{{ content }}</slot>
      </div>
    </div>
  </div>
</template>
